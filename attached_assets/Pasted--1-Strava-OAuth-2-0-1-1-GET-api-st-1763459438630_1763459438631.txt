üî• 1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å–æ Strava OAuth 2.0

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ:

1.1 –°–æ–∑–¥–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
GET /api/strava/auth
GET /api/strava/callback


–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

/auth ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ Strava –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

/callback ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç code, –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã (access_token, refresh_token, expires_at)

—Å–æ–∑–¥–∞–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è userId (uuid)

—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç Strava-–ø—Ä–æ—Ñ–∏–ª—å –≤ —Ç–∞–±–ª–∏—Ü—É strava_accounts

–ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞ ‚Äî –¥–µ–ª–∞–µ—Ç redirect –Ω–∞ /rating

üî• 2. –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ drizzle ORM

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª shared/strava-schema.ts –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å:

2.1 –¢–∞–±–ª–∏—Ü–∞ strava_accounts

–ü–æ–ª—è:

id (uuid PK)

userId (uuid, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

stravaId (int, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π)

accessToken (text)

refreshToken (text)

expiresAt (bigint timestamp)

2.2 –¢–∞–±–ª–∏—Ü–∞ activities

–ü–æ–ª—è:

id (bigint, PK, ID –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ Strava)

userId (uuid)

name (text)

distance (real)

movingTime (integer)

sportType (text)

polyline (text)

startDate (timestamp)

üî• 3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:

server/services/strava-sync.ts


–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

—Ñ—É–Ω–∫—Ü–∏—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ Strava (refresh_token)

–∑–∞–≥—Ä—É–∑–∫—É –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π —Å–ø–æ—Ä—Ç—Å–º–µ–Ω–∞:

–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GET /athlete/activities

—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ Run –∏ TrailRun

—Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ PostgreSQL

–æ–±–Ω–æ–≤–ª—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ, –µ—Å–ª–∏ Strava –∏—Ö –∏–∑–º–µ–Ω–∏–ª

üî• 4. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫—Ä–æ–Ω-–∑–∞–¥–∞—á—É

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:

scripts/cron-sync.js


–ö—Ä–æ–Ω –¥–æ–ª–∂–µ–Ω:

—Ä–∞–∑ –≤ —á–∞—Å –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ strava_accounts

–æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–∫–µ–Ω—ã, –µ—Å–ª–∏ –∏—Å—Ç–µ–∫–ª–∏

—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

üî• 5. –î–æ–±–∞–≤–∏—Ç—å API —Ä–µ–π—Ç–∏–Ω–≥–∞

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:

server/routes/rating.ts


–≠–Ω–¥–ø–æ–∏–Ω—Ç:

GET /api/rating?year=YYYY&month=MM


–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ —Å—É–º–º–µ –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤.

–ü—Ä–∏–º–µ—Ä SQL:

SELECT user_id,
       SUM(distance) AS total_distance
FROM activities
WHERE date_part('year', start_date) = $year
  AND ($month IS NULL OR date_part('month', start_date) = $month)
GROUP BY user_id
ORDER BY total_distance DESC;

üî• 6. –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–æ—É—Ç–µ—Ä—ã –≤ server/index.ts

–î–æ–±–∞–≤–∏—Ç—å:

import stravaRoutes from "./routes/strava";
import ratingRoutes from "./routes/rating";

app.use("/api/strava", stravaRoutes);
app.use("/api/rating", ratingRoutes);

üî• 7. –°–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏—á–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–π—Ç–∏–Ω–≥–∞ (Vite frontend)

–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É /rating:

—Ç–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∏–ª–æ–º–µ—Ç—Ä–∞–º

—Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≥–æ–¥—É –∏ –º–µ—Å—è—Ü—É

–∫–Ω–æ–ø–∫–∞ ¬´–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Strava¬ª

–ö–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω–∞ –≤–µ—Å—Ç–∏ –Ω–∞:

/api/strava/auth

üî• 8. Environment variables

–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

STRAVA_CLIENT_ID=185923
STRAVA_CLIENT_SECRET=9f903296d0f2397711a7561a96db355fa8a84e43
STRAVA_REDIRECT_URI=https://mikkeller-rc.mikkeller.ru/api/strava/callback

üî• 9. –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ç–∏–ª—é –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø—Ä–æ–µ–∫—Ç–∞

Express + TypeScript + Drizzle ORM

Vite frontend –Ω–µ –º–µ–Ω—è—Ç—å, —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–π—Ç–∏–Ω–≥–∞

–ù–∏–∫–∞–∫–∏—Ö breaking changes

–ê–¥–º–∏–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–ë–µ–≥—É–Ω—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî —Ç–æ–ª—å–∫–æ Strava OAuth

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –≤—Å–µ –æ–ø–∏—Å–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏.